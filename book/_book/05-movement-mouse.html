<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.43">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>5&nbsp; A mouse’s daily activity log – Animals In Motion</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./06-movement-zebras.html" rel="next">
<link href="./04-movement-intro.html" rel="prev">
<link href="./img/logo_niu_light.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-ff95b8d4491e34369033edb2da9d3cd5.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-f7f9133ac2fec27fcbac322ddc22cf60.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./05-movement-mouse.html"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">A mouse’s daily activity log</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      <img src="./img/animals-in-motion-logo.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Animals In Motion</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/neuroinformatics-unit/animals-in-motion/tree/main/book/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-deep-learning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Deep learning for computer vision primer</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-sleap-tutorial.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Pose estimation with SLEAP</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-movement-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Analysing tracks with movement</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-movement-mouse.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">A mouse’s daily activity log</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-movement-zebras.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Zebra escape trajectories</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./prerequisites.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Prerequisites</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./contributing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Contributing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">References</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#import-libraries" id="toc-import-libraries" class="nav-link active" data-scroll-target="#import-libraries"><span class="header-section-number">5.1</span> Import libraries</a></li>
  <li><a href="#the-smart-kages-dataset" id="toc-the-smart-kages-dataset" class="nav-link" data-scroll-target="#the-smart-kages-dataset"><span class="header-section-number">5.2</span> The Smart-Kages dataset</a></li>
  <li><a href="#datetime-coordinates" id="toc-datetime-coordinates" class="nav-link" data-scroll-target="#datetime-coordinates"><span class="header-section-number">5.3</span> Datetime Coordinates</a></li>
  <li><a href="#cleaning-the-data" id="toc-cleaning-the-data" class="nav-link" data-scroll-target="#cleaning-the-data"><span class="header-section-number">5.4</span> Cleaning the data</a></li>
  <li><a href="#plot-the-mouses-speed-over-time" id="toc-plot-the-mouses-speed-over-time" class="nav-link" data-scroll-target="#plot-the-mouses-speed-over-time"><span class="header-section-number">5.5</span> Plot the mouse’s speed over time</a></li>
  <li><a href="#sec-actograms" id="toc-sec-actograms" class="nav-link" data-scroll-target="#sec-actograms"><span class="header-section-number">5.6</span> Plot actograms</a></li>
  <li><a href="#space-occupancy" id="toc-space-occupancy" class="nav-link" data-scroll-target="#space-occupancy"><span class="header-section-number">5.7</span> Space occupancy</a></li>
  <li><a href="#region-of-interest-occupancy" id="toc-region-of-interest-occupancy" class="nav-link" data-scroll-target="#region-of-interest-occupancy"><span class="header-section-number">5.8</span> Region of interest occupancy</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/neuroinformatics-unit/animals-in-motion/edit/main/book/05-movement-mouse.qmd" target="_blank" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/neuroinformatics-unit/animals-in-motion/blob/main/book/05-movement-mouse.qmd" target="_blank" class="toc-action"><i class="bi empty"></i>View source</a></li><li><a href="https://github.com/neuroinformatics-unit/animals-in-motion/issues/new" target="_blank" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-movement-mouse" class="quarto-section-identifier"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">A mouse’s daily activity log</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>In this case study, we’ll be using the <a href="https://movement.neuroinformatics.dev/"><code>movement</code> package</a> to dive into mouse home cage monitoring data acquired in <a href="https://cambridgephenotyping.com/products">Smart-Kages</a> and tracked with <a href="https://www.deeplabcut.org/">DeepLabCut</a>. We’ll explore how mouse activity levels fluctuate throughout the day.</p>
<p>Before you get started, make sure you’ve set up the <code>animals-in-motion-env</code> environment (refer to <a href="prerequisites.html#sec-install-movement" class="quarto-xref">prerequisites&nbsp;<span>A.3.3</span></a>) and are using it to run this code. You’ll also need to download the <code>Smart-Kages.zip</code> archive from <a href="https://www.dropbox.com/scl/fo/81ug5hoy9msc7v7bteqa0/AH32RLdbZqWZJstIeR4YHZY?rlkey=blgagtaizw8aac5areja6h7q1&amp;st=w1zueyi9&amp;dl=0">Dropbox</a> (see <a href="prerequisites.html#sec-data" class="quarto-xref">prerequisites&nbsp;<span>A.4</span></a>) and unzip it.</p>
<section id="import-libraries" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="import-libraries"><span class="header-section-number">5.1</span> Import libraries</h2>
<div id="43bbfcbb" class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib <span class="im">import</span> colormaps</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> movement <span class="im">import</span> sample_data</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> movement.filtering <span class="im">import</span> filter_by_confidence, rolling_filter</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> movement.kinematics <span class="im">import</span> compute_speed</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> movement.plots <span class="im">import</span> plot_occupancy</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> movement.roi <span class="im">import</span> PolygonOfInterest</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> movement.transforms <span class="im">import</span> scale</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="the-smart-kages-dataset" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="the-smart-kages-dataset"><span class="header-section-number">5.2</span> The Smart-Kages dataset</h2>
<div class="callout callout-style-default callout-note callout-titled" title="Acknowledgement">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Acknowledgement
</div>
</div>
<div class="callout-body-container callout-body">
<p>This dataset was kindly shared by <a href="https://www.sainsburywellcome.org/web/people/loukia-katsouri">Dr.&nbsp;Loukia Katsouri</a> from the <a href="https://www.sainsburywellcome.org/web/groups/okeefe-lab">O’Keefe Lab</a>, with permission to use for this workshop.</p>
</div>
</div>
<p>The Smart-Kages dataset comprises home cage recordings from two mice, each housed in a specialised <a href="https://cambridgephenotyping.com/products">Smart-Kage</a> <span class="citation" data-cites="ho_fully_2023">(<a href="references.html#ref-ho_fully_2023" role="doc-biblioref">Ho et al. 2023</a>)</span>—a home cage monitoring system equipped with a camera mounted atop the cage.</p>
<p>The camera captures data around the clock at a rate of 2 frames per second, saving a video segment for each hour of the day. A pre-trained DeepLabCut model is then used to predict 8 keypoints on the mouse’s body.</p>
<p>Let’s examine the contents of the downloaded data. You will need to specify the path to the unzipped <code>Smart-Kages</code> folder on your machine.</p>
<div id="bf954f02" class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace with the path to the unzipped Smart-Kages folder on your machine</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>smart_kages_path <span class="op">=</span> Path.home() <span class="op">/</span> <span class="st">".movement"</span> <span class="op">/</span> <span class="st">"Smart-Kages"</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's visualise the contents of the folder</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>files <span class="op">=</span> [f.name <span class="cf">for</span> f <span class="kw">in</span> smart_kages_path.iterdir()]</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>files.sort()</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> files:</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="bu">file</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The tracking data are stored in two<code>.nc</code> (netCDF) files: <code>kage14</code> and <code>kage17</code>. netCDF is an HDF5-based file format that can be natively saved/loaded by the <code>xarray</code> library, and is therefore <a href="https://movement.neuroinformatics.dev/user_guide/input_output.html#native-saving-and-loading-with-netcdf">convenient to use with <code>movement</code></a>.</p>
<p>Apart from these, we also have two <code>.png</code> files: <code>kage14_background.png</code> and <code>kage17_background.png</code>, which constitute frames extracted from the videos.</p>
<p>Let’s take a look at them.</p>
<div id="fig-background-frames" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-background-frames-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>kages <span class="op">=</span> [<span class="st">"kage14"</span>, <span class="st">"kage17"</span>]</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>img_paths <span class="op">=</span> [smart_kages_path <span class="op">/</span> <span class="ss">f"</span><span class="sc">{</span>kage<span class="sc">}</span><span class="ss">_background.png"</span> <span class="cf">for</span> kage <span class="kw">in</span> kages]</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>images <span class="op">=</span> [plt.imread(img_path) <span class="cf">for</span> img_path <span class="kw">in</span> img_paths]</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(nrows<span class="op">=</span><span class="dv">1</span>, ncols<span class="op">=</span><span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">4</span>))</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, img <span class="kw">in</span> <span class="bu">enumerate</span>(images):</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    axes[i].imshow(img)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    axes[i].set_title(<span class="ss">f"</span><span class="sc">{</span>kages[i]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    axes[i].axis(<span class="st">"off"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-background-frames-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.1
</figcaption>
</figure>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Questions A">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Questions A
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>What objects do you see in the habitat?</li>
<li>What challenges do you anticipate with tracking a mouse in this environment?</li>
<li>What are the trade-offs one has to consider when designing a continuous monitoring system?</li>
</ol>
</div>
</div>
<p>Let’s load and inspect the tracking data:</p>
<div id="97a6057b" class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>ds_kages <span class="op">=</span> {}  <span class="co"># a dictionary to store kage name -&gt; xarray dataset</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> kage <span class="kw">in</span> [<span class="st">"kage14"</span>, <span class="st">"kage17"</span>]:</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    ds_kages[kage] <span class="op">=</span> xr.open_dataset(smart_kages_path <span class="op">/</span> <span class="ss">f"</span><span class="sc">{</span>kage<span class="sc">}</span><span class="ss">.nc"</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>ds_kages[<span class="st">"kage14"</span>]   <span class="co"># Change to "kage17" to inspect the other dataset</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We see that each dataset contains a huge amount of data, but the two datasets are not exactly aligned in time.</p>
<div id="93f1432b" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>start_times <span class="op">=</span> {</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    name: pd.Timestamp(ds.time.isel(time<span class="op">=</span><span class="dv">0</span>).values)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name, ds <span class="kw">in</span> ds_kages.items()</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>end_times <span class="op">=</span> {</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    name: pd.Timestamp(ds.time.isel(time<span class="op">=-</span><span class="dv">1</span>).values)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name, ds <span class="kw">in</span> ds_kages.items()</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name <span class="kw">in</span> start_times.keys():</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">: from </span><span class="sc">{</span>start_times[name]<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>end_times[name]<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="datetime-coordinates" class="level2" data-number="5.3">
<h2 data-number="5.3" class="anchored" data-anchor-id="datetime-coordinates"><span class="header-section-number">5.3</span> Datetime Coordinates</h2>
<p>You might notice something interesting about the time coordinates in these <code>xarray</code> datasets: they’re given in <code>datetime64[ns]</code> format, which means they’re precise timestamps expressed in “calendar time”.</p>
<p>This is different from what we’ve seen before in other <code>movement</code> datasets, where time coordinates are expressed as seconds elapsed since the start of the video, or “elapsed time”.</p>
<div class="callout callout-style-default callout-note callout-titled" title="How did we get these timestamps?">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
How did we get these timestamps?
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Some recording systems can output timestamps for each video frame. In our case, the raw data from the Smart-Kage system included the start datetime of each 1-hour-long video segment and the precise time difference between the start of each segment and every frame within it.</p>
<p>Using this information, we were able to reconstruct precise datetime coordinates for all frames throughout the entire experiment. We then concatenated the DeepLabCut predictions from all video segments and assigned the datetime coordinates to the resulting dataset. If you’re interested in the details, you can find the code in the <a href="https://github.com/neuroinformatics-unit/smart-kages-movement">smart-kages-movement GitHub repository</a>.</p>
</div>
</div>
</div>
<p>Using “calendar time” is convenient for many applications. For example, we could cross-reference the tracking results against other data sources, such as body weight measurements.</p>
<p>It also allows us to easily select time windows by datetime. We will leverage this here to select a time window that’s common to both kages. Note that we discard the last few days because the experimenter introduced some interventions during that time, which are out of scope for this case study.</p>
<div id="f1b9f368" class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>common_start <span class="op">=</span> <span class="st">"2024-04-09 00:00:00"</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>common_end <span class="op">=</span> <span class="st">"2024-05-07 00:00:00"</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> kage <span class="kw">in</span> [<span class="st">"kage14"</span>, <span class="st">"kage17"</span>]:</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    ds_kages[kage] <span class="op">=</span> ds_kages[kage].sel(time<span class="op">=</span><span class="bu">slice</span>(common_start, common_end))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Beyond this ability to select time windows by date and time, we will see many other benefits of using datetime coordinates in the rest of this case study.</p>
<p>That said, it’s still useful to also know the total time elapsed since the start of the experiment. In fact, many <code>movement</code> functions will expect “elapsed time” and may not work with datetime coordinates (for now).</p>
<p>Luckily, it’s easy to convert datetime coordinates to “elapsed time” by simply subtracting the start datetime of the whole experiment from each timestamp.</p>
<div id="820d38e2" class="cell">
<details class="code-fold">
<summary>Expand to see how this can be done</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>ds_14 <span class="op">=</span> ds_kages[<span class="st">"kage14"</span>]</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the start datetime the experiment in kage14</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>experiment_start <span class="op">=</span> ds_14.time.isel(time<span class="op">=</span><span class="dv">0</span>).data</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Subtract the start datetime from each timestamp</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>time_elapsed <span class="op">=</span> (ds_14.time.data <span class="op">-</span> np.datetime64(experiment_start))</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to seconds</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>seconds_elapsed <span class="op">=</span> time_elapsed <span class="op">/</span> pd.Timedelta(<span class="st">"1s"</span>)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign the seconds_elapsed coordinate to the "time" dimension</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>ds_14 <span class="op">=</span> ds_14.assign_coords(seconds_elapsed<span class="op">=</span>(<span class="st">"time"</span>, seconds_elapsed))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We’ve pre-computed this for convenience and stored it in a secondary time coordinate called <code>seconds_elapsed</code>.</p>
<div id="fc84a826" class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(ds_14.coords[<span class="st">"time"</span>].values[:<span class="dv">2</span>])</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(ds_14.coords[<span class="st">"seconds_elapsed"</span>].values[:<span class="dv">2</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Whenever we want to switch to “elapsed time” mode, we can simply set the <code>seconds_elapsed</code> coordinates as the “index” of the <code>time</code> dimension. This means that <code>seconds_elapsed</code> will be used as the primary time coordinate, allowing us to select data by it.</p>
<div id="fe10ee51" class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>ds_14.set_index(time<span class="op">=</span><span class="st">"seconds_elapsed"</span>).sel(time<span class="op">=</span><span class="bu">slice</span>(<span class="dv">0</span>, <span class="dv">1800</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Exercise A">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise A
</div>
</div>
<div class="callout-body-container callout-body">
<p>For each of the two kages:</p>
<ol type="1">
<li>Plot the x-axis position of the mouse’s body center over time, for the week starting on April 15th. What do you notice?</li>
<li>Plot the median confidence of the body center for each day, over the entire duration of the experiment.</li>
</ol>
</div>
</div>
</section>
<section id="cleaning-the-data" class="level2" data-number="5.4">
<h2 data-number="5.4" class="anchored" data-anchor-id="cleaning-the-data"><span class="header-section-number">5.4</span> Cleaning the data</h2>
<p>Let’s examine the range of confidence values for each keypoint.</p>
<div id="fig-confidence-range" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-confidence-range-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>kage <span class="op">=</span> <span class="st">"kage14"</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>confidence <span class="op">=</span> ds_kages[kage].confidence.squeeze()</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">3</span>))</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>confidence.quantile(q<span class="op">=</span><span class="fl">0.25</span>, dim<span class="op">=</span><span class="st">"time"</span>).plot.line(<span class="st">"o--"</span>, color<span class="op">=</span><span class="st">"gray"</span>, ax<span class="op">=</span>ax, label<span class="op">=</span><span class="st">"25% quantile"</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>confidence.quantile(q<span class="op">=</span><span class="fl">0.75</span>, dim<span class="op">=</span><span class="st">"time"</span>).plot.line(<span class="st">"o--"</span>, color<span class="op">=</span><span class="st">"gray"</span>, ax<span class="op">=</span>ax, label<span class="op">=</span><span class="st">"75% quantile"</span>)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>confidence.median(dim<span class="op">=</span><span class="st">"time"</span>).plot.line(<span class="st">"o-"</span>, color<span class="op">=</span><span class="st">"black"</span>, ax<span class="op">=</span>ax, label<span class="op">=</span><span class="st">"median"</span>)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>ax.legend()</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="ss">f"</span><span class="sc">{</span>kage<span class="sc">}</span><span class="ss"> confidence range"</span>)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-confidence-range-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.2
</figcaption>
</figure>
</div>
<p>It looks like the “neck”, “bodycenter”, “spine1”, and “spine2” keypoints are the most confidently detected. Let us define a list of “reliable” keypoints for later use. These are all on the mouse’s body.</p>
<div id="a93beb2b" class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>reliable_keypoints <span class="op">=</span> [<span class="st">"neck"</span>, <span class="st">"bodycenter"</span>, <span class="st">"spine1"</span>, <span class="st">"spine2"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can filter out low-confidence predictions.</p>
<div id="c390387e" class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>confidence_threshold <span class="op">=</span> <span class="fl">0.95</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> kage, ds <span class="kw">in</span> ds_kages.items():</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    ds[<span class="st">"position_filtered"</span>] <span class="op">=</span> filter_by_confidence(</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>        ds.position,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>        ds.confidence,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>        threshold<span class="op">=</span>confidence_threshold,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Exercise B">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise B
</div>
</div>
<div class="callout-body-container callout-body">
<p>Let’s smooth the data with a rolling median filter.</p>
<p><strong>Hint</strong>: Remember doing this in <a href="04-movement-intro.html" class="quarto-xref"><span>Chapter 4</span></a> ?</p>
</div>
</div>
</section>
<section id="plot-the-mouses-speed-over-time" class="level2" data-number="5.5">
<h2 data-number="5.5" class="anchored" data-anchor-id="plot-the-mouses-speed-over-time"><span class="header-section-number">5.5</span> Plot the mouse’s speed over time</h2>
<p>Let’s define a single-point representation of the mouse’s position, which we’ll call the <code>body_centroid</code>. We derive this by taking the mean of the 4 reliable keypoints, using their smoothed positions.</p>
<div id="cfc69053" class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> kage, ds <span class="kw">in</span> ds_kages.items():</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    ds[<span class="st">"body_centroid"</span>] <span class="op">=</span> ds.position_filtered.sel(</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>        individuals<span class="op">=</span><span class="st">"individual_0"</span>,  <span class="co"># the only individual in the dataset</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>        keypoints<span class="op">=</span>reliable_keypoints</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    ).mean(dim<span class="op">=</span><span class="st">"keypoints"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we’ll compute the body centroid’s speed in cm/sec via the following steps:</p>
<ol type="1">
<li>Convert the body centroid position data to cm units using <a href="https://movement.neuroinformatics.dev/api/movement.transforms.scale.html"><code>scale()</code></a>.</li>
<li>Temporarily switch to “elapsed time” mode, because <a href="https://movement.neuroinformatics.dev/api/movement.kinematics.compute_speed.html"><code>compute_speed()</code></a> does not (yet) support datetime coordinates.</li>
<li>Compute the speed in cm/sec</li>
<li>Restore the original datetime coordinates to the speed data.</li>
</ol>
<div id="c847c431" class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>PIXELS_PER_CM <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> kage, ds <span class="kw">in</span> ds_kages.items():</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Scale from pixels to cm using a known conversion factor</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    body_centroid_cm <span class="op">=</span> scale(</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>        ds.body_centroid, factor<span class="op">=</span><span class="dv">1</span> <span class="op">/</span> PIXELS_PER_CM, space_unit<span class="op">=</span><span class="st">"cm"</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute the speed in cm/sec</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    ds[<span class="st">"body_centroid_speed"</span>] <span class="op">=</span> compute_speed(</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>       body_centroid_cm.set_index(time<span class="op">=</span><span class="st">"seconds_elapsed"</span>)  <span class="co"># switch time coords</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    ).assign_coords(time<span class="op">=</span>body_centroid_cm.time)            <span class="co"># restore datetime</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>ds_kages[<span class="st">"kage14"</span>].body_centroid_speed</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s plot the speed over time.</p>
<div id="fig-body-speed" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-body-speed-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode cell-code" id="fig-body-speed"><pre class="sourceCode python cell code-with-copy"><code class="sourceCode python"><span id="fig-body-speed-1"><a href="#fig-body-speed-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(</span>
<span id="fig-body-speed-2"><a href="#fig-body-speed-2" aria-hidden="true" tabindex="-1"></a>    nrows<span class="op">=</span><span class="dv">2</span>, ncols<span class="op">=</span><span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">5</span>), sharex<span class="op">=</span><span class="va">True</span>, sharey<span class="op">=</span><span class="va">True</span></span>
<span id="fig-body-speed-3"><a href="#fig-body-speed-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="fig-body-speed-4"><a href="#fig-body-speed-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="fig-body-speed-5"><a href="#fig-body-speed-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, kage <span class="kw">in</span> <span class="bu">enumerate</span>([<span class="st">"kage14"</span>, <span class="st">"kage17"</span>]):</span>
<span id="fig-body-speed-6"><a href="#fig-body-speed-6" aria-hidden="true" tabindex="-1"></a>    ds_kages[kage].body_centroid_speed.plot.line(ax<span class="op">=</span>axes[i])</span>
<span id="fig-body-speed-7"><a href="#fig-body-speed-7" aria-hidden="true" tabindex="-1"></a>    axes[i].set_title(<span class="ss">f"</span><span class="sc">{</span>kage<span class="sc">}</span><span class="ss"> body centroid"</span>)</span>
<span id="fig-body-speed-8"><a href="#fig-body-speed-8" aria-hidden="true" tabindex="-1"></a>    axes[i].set_ylabel(<span class="st">"speed (cm/sec)"</span>)</span>
<span id="fig-body-speed-9"><a href="#fig-body-speed-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="fig-body-speed-10"><a href="#fig-body-speed-10" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="fig-body-speed-11"><a href="#fig-body-speed-11" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-body-speed-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.3
</figcaption>
</figure>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Questions B">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Questions B
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>What are potential sources of error in the speed calculation?</li>
<li>What do you notice about the overall speed fluctuations over time? What do you think is the reason for this?</li>
<li>Do you notice any differences between the two kages? Feel free to “zoom in” on specific time windows to investigate this.</li>
</ol>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="A side-note on 3D pose estimation">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
A side-note on 3D pose estimation
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>With only a single top-down view of the mouse, we are limited to 2D pose estimation. This means the estimated keypoint coordinates are simply projections of the true 3D coordinates onto the 2D image plane.</p>
<p>This is the most common approach to pose estimation, but it cannot accurately measure true dimensions. Any conversion from pixels to physical units (e.g.&nbsp;centimetres) will be imprecise, and sometimes significantly so.</p>
<p>This limitation can be overcome by using multiple cameras from different viewpoints and performing 3D pose estimation. There are two main markerless approaches:</p>
<ol type="1">
<li><p>The first approach is to do ‘regular’ 2D pose estimation in each camera view, then triangulate across camera views to estimate 3D pose. The triangulation relies on known parameters about the cameras and their relative positions and orientations. <a href="https://anipose.readthedocs.io/en/latest/">Anipose</a> <span class="citation" data-cites="karashchuk_anipose_2021">(<a href="references.html#ref-karashchuk_anipose_2021" role="doc-biblioref">Karashchuk et al. 2021</a>)</span> is a popular open-source toolkit that implements this approach.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/pose_estimation_3D.png" class="img-fluid figure-img"></p>
<figcaption>Source: <span class="citation" data-cites="pereira_quantifying_2020">Pereira, Shaevitz, and Murthy (<a href="references.html#ref-pereira_quantifying_2020" role="doc-biblioref">2020</a>)</span></figcaption>
</figure>
</div></li>
<li><p>The second approach, implemented in <a href="https://github.com/spoonsso/dannce">DANNCE</a> <span class="citation" data-cites="dunn_geometric_2021">(<a href="references.html#ref-dunn_geometric_2021" role="doc-biblioref">Dunn et al. 2021</a>)</span>, is to use a fully 3D convolutional neural network (CNN) that can learn about 3D image features and how cameras and landmarks relate to one another in 3D space.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/DANNCE.png" class="img-fluid figure-img"></p>
<figcaption>Source: <a href="https://github.com/spoonsso/dannce" class="uri">https://github.com/spoonsso/dannce</a></figcaption>
</figure>
</div></li>
</ol>
<p>Some <strong>prompts for discussion</strong>:</p>
<ul>
<li>What are the pros and cons of 2D vs 3D markerless pose estimation?</li>
<li>In which scenarios would you prefer one over the other?</li>
</ul>
</div>
</div>
</div>
</section>
<section id="sec-actograms" class="level2" data-number="5.6">
<h2 data-number="5.6" class="anchored" data-anchor-id="sec-actograms"><span class="header-section-number">5.6</span> Plot actograms</h2>
<p>An actogram is a visualisation of the mouse’s activity level over time.</p>
<p>As a measure of activity we’ll use the cumulative distance traversed by the mouse’s body centroid in a given time bin—in this case, 10 minutes. Since we have already computed the speed (cm/sec), we can multiply that by the time bin duration in seconds to get the distance (cm).</p>
<div id="42fcdffd" class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> kage <span class="kw">in</span> [<span class="st">"kage14"</span>, <span class="st">"kage17"</span>]:</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    time_diff <span class="op">=</span> ds_kages[kage].coords[<span class="st">"seconds_elapsed"</span>].diff(dim<span class="op">=</span><span class="st">"time"</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    ds_kages[kage][<span class="st">"distance"</span>] <span class="op">=</span> ds_kages[kage].body_centroid_speed <span class="op">*</span> time_diff</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then we can sum the distance traversed in each time bin to get the activity level.</p>
<div id="fig-activity-levels" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-activity-levels-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode cell-code" id="fig-activity-levels"><pre class="sourceCode python cell code-with-copy"><code class="sourceCode python"><span id="fig-activity-levels-1"><a href="#fig-activity-levels-1" aria-hidden="true" tabindex="-1"></a>time_bin_minutes <span class="op">=</span> <span class="dv">10</span></span>
<span id="fig-activity-levels-2"><a href="#fig-activity-levels-2" aria-hidden="true" tabindex="-1"></a>time_bin_duration <span class="op">=</span> pd.Timedelta(<span class="ss">f"</span><span class="sc">{</span>time_bin_minutes<span class="sc">}</span><span class="ss">min"</span>)</span>
<span id="fig-activity-levels-3"><a href="#fig-activity-levels-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="fig-activity-levels-4"><a href="#fig-activity-levels-4" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(</span>
<span id="fig-activity-levels-5"><a href="#fig-activity-levels-5" aria-hidden="true" tabindex="-1"></a>    nrows<span class="op">=</span><span class="dv">2</span>, ncols<span class="op">=</span><span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">5</span>), sharex<span class="op">=</span><span class="va">True</span>, sharey<span class="op">=</span><span class="va">True</span></span>
<span id="fig-activity-levels-6"><a href="#fig-activity-levels-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="fig-activity-levels-7"><a href="#fig-activity-levels-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="fig-activity-levels-8"><a href="#fig-activity-levels-8" aria-hidden="true" tabindex="-1"></a>activity_dict <span class="op">=</span> {}  <span class="co"># Dictionary to store the activity levels for each kage</span></span>
<span id="fig-activity-levels-9"><a href="#fig-activity-levels-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="fig-activity-levels-10"><a href="#fig-activity-levels-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, kage <span class="kw">in</span> <span class="bu">enumerate</span>([<span class="st">"kage14"</span>, <span class="st">"kage17"</span>]):</span>
<span id="fig-activity-levels-11"><a href="#fig-activity-levels-11" aria-hidden="true" tabindex="-1"></a>    activity <span class="op">=</span> ds_kages[kage].distance.resample(time<span class="op">=</span>time_bin_duration).<span class="bu">sum</span>()</span>
<span id="fig-activity-levels-12"><a href="#fig-activity-levels-12" aria-hidden="true" tabindex="-1"></a>    activity.plot.line(ax<span class="op">=</span>ax[i])</span>
<span id="fig-activity-levels-13"><a href="#fig-activity-levels-13" aria-hidden="true" tabindex="-1"></a>    ax[i].set_title(<span class="ss">f"</span><span class="sc">{</span>kage<span class="sc">}</span><span class="ss"> activity"</span>)</span>
<span id="fig-activity-levels-14"><a href="#fig-activity-levels-14" aria-hidden="true" tabindex="-1"></a>    ax[i].set_ylabel(<span class="st">"distance (cm)"</span>)</span>
<span id="fig-activity-levels-15"><a href="#fig-activity-levels-15" aria-hidden="true" tabindex="-1"></a>    ax[i].set_xlabel(<span class="st">"time"</span>)</span>
<span id="fig-activity-levels-16"><a href="#fig-activity-levels-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="fig-activity-levels-17"><a href="#fig-activity-levels-17" aria-hidden="true" tabindex="-1"></a>    activity_dict[kage] <span class="op">=</span> activity</span>
<span id="fig-activity-levels-18"><a href="#fig-activity-levels-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="fig-activity-levels-19"><a href="#fig-activity-levels-19" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="fig-activity-levels-20"><a href="#fig-activity-levels-20" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-activity-levels-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.4
</figcaption>
</figure>
</div>
<p>To make any circadian patterns more apparent, we will stack days vertically and indicate the light cycle with gray areas. For this particular experiment, the light cycle is as follows:</p>
<ul>
<li>lights off at 9:30</li>
<li>dawn at 20:30</li>
<li>lights on at 21:30</li>
</ul>
<div id="0d7d3d6d" class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define light cycle (in minutes since midnight)</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>lights_off <span class="op">=</span> <span class="dv">9</span> <span class="op">*</span> <span class="dv">60</span> <span class="op">+</span> <span class="dv">30</span>  <span class="co"># 9:30 AM in minutes</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>dawn <span class="op">=</span> <span class="dv">20</span> <span class="op">*</span> <span class="dv">60</span> <span class="op">+</span> <span class="dv">30</span>       <span class="co"># 8:30 PM in minutes  </span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>lights_on <span class="op">=</span> <span class="dv">21</span> <span class="op">*</span> <span class="dv">60</span> <span class="op">+</span> <span class="dv">30</span>  <span class="co"># 9:30 PM in minutes</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>n_bins_in_day <span class="op">=</span> <span class="bu">int</span>(<span class="dv">24</span> <span class="op">*</span> <span class="dv">60</span> <span class="op">/</span> time_bin_minutes)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>actogram_dict <span class="op">=</span> {}  <span class="co"># Dictionary to store the 2D actogram for each kage</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, kage <span class="kw">in</span> <span class="bu">enumerate</span>([<span class="st">"kage14"</span>, <span class="st">"kage17"</span>]):</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    activity <span class="op">=</span> activity_dict[kage]</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    days <span class="op">=</span> <span class="bu">list</span>(activity.groupby(<span class="st">"time.date"</span>).groups.keys())</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create an empty 2D actogram with dims (date, time_bin)</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    actogram <span class="op">=</span> xr.DataArray(</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>        np.zeros((<span class="bu">len</span>(days), n_bins_in_day)),</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>        dims<span class="op">=</span>[<span class="st">"date"</span>, <span class="st">"time_of_day"</span>],</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>        coords<span class="op">=</span>{</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">"date"</span>: days,</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">"time_of_day"</span>: np.arange(</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>                time_bin_minutes<span class="op">/</span><span class="dv">2</span>, <span class="dv">24</span> <span class="op">*</span> <span class="dv">60</span>, time_bin_minutes</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Populate 2D actogram per day</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> date, day_activity <span class="kw">in</span> activity.groupby(<span class="st">"time.date"</span>):</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>        actogram.loc[<span class="bu">dict</span>(date<span class="op">=</span>date)] <span class="op">=</span> day_activity.values</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store the actogram in the dictionary for later use</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>    actogram_dict[kage] <span class="op">=</span> actogram</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>actogram_dict[<span class="st">"kage14"</span>]  <span class="co"># Replace with kage17 to see the actogram for kage17</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s now visualise the actograms, with the light cycle marked.</p>
<div id="fig-actograms" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-actograms-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>max_activity <span class="op">=</span> <span class="bu">max</span>(</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    actogram_dict[kage].<span class="bu">max</span>().values <span class="cf">for</span> kage <span class="kw">in</span> [<span class="st">"kage14"</span>, <span class="st">"kage17"</span>]</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    nrows<span class="op">=</span><span class="dv">2</span>, ncols<span class="op">=</span><span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">8</span>), sharex<span class="op">=</span><span class="va">True</span>, sharey<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, kage <span class="kw">in</span> <span class="bu">enumerate</span>([<span class="st">"kage14"</span>, <span class="st">"kage17"</span>]):</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    actogram <span class="op">=</span> actogram_dict[kage]</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a colormap for the actogram</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    cmap <span class="op">=</span> colormaps.get_cmap(<span class="st">"Greys"</span>)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    cmap.set_bad(color<span class="op">=</span><span class="st">"brown"</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)  <span class="co"># Set bad values to red</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot the actogram</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> axes[i]</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    actogram.plot(</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>        ax<span class="op">=</span>ax, yincrease<span class="op">=</span><span class="va">False</span>, vmin<span class="op">=</span><span class="dv">0</span>, vmax<span class="op">=</span>max_activity, cmap<span class="op">=</span>cmap</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Assign x-tick labels every 4 hours formatted as HH:MM</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>    ax.set_xticks(np.arange(<span class="dv">0</span>, <span class="dv">24</span> <span class="op">*</span> <span class="dv">60</span> <span class="op">+</span> <span class="dv">1</span>, <span class="dv">4</span> <span class="op">*</span> <span class="dv">60</span>))</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>    ax.set_xticklabels([<span class="ss">f"</span><span class="sc">{</span>i<span class="sc">:02d}</span><span class="ss">:00"</span> <span class="cf">for</span> i <span class="kw">in</span> np.arange(<span class="dv">0</span>, <span class="dv">25</span>, <span class="dv">4</span>)])</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mark light cycle</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>    ax.axvline(lights_off, color<span class="op">=</span><span class="st">"red"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, lw<span class="op">=</span><span class="dv">2</span>, linestyle<span class="op">=</span><span class="st">"-"</span>, label<span class="op">=</span><span class="st">"lights off"</span>)</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>    ax.axvline(dawn, color<span class="op">=</span><span class="st">"blue"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, lw<span class="op">=</span><span class="dv">2</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, label<span class="op">=</span><span class="st">"dawn"</span>)</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>    ax.axvline(lights_on, color<span class="op">=</span><span class="st">"blue"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, lw<span class="op">=</span><span class="dv">2</span>, linestyle<span class="op">=</span><span class="st">"-"</span>, label<span class="op">=</span><span class="st">"lights on"</span>)</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>    ax.legend(loc<span class="op">=</span><span class="st">"lower left"</span>)</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set title and axis labels</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="ss">f"</span><span class="sc">{</span>kage<span class="sc">}</span><span class="ss"> actogram"</span>)</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">"Time of day"</span>)</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-actograms-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.5
</figcaption>
</figure>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Exercise C">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise C
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>How would you describe the observed differences between the two mice?</li>
<li>Compute the mean activity profile (across days) for each mouse.</li>
<li>Plot the mean activity profile for each mouse, with the light cycle marked.</li>
</ol>
<p><strong>Hint</strong>: Start with the <code>actogram_dict</code> dictionary and also make use of the <code>lights_off</code> and <code>lights_on</code> variables defined above.</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="What underlies the differences in activity?">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-9-contents" aria-controls="callout-9" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What underlies the differences in activity?
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-9" class="callout-9-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The mouse in <code>kage17</code> is a genetically modified model of Down Syndrome. The syndrome, also known as trisomy 21, is caused in humans by the presence of all or part of a third copy of chromosome 21. The mouse in <code>kage17</code> is genetically modified with a triplication of mouse chromosome 16, which carries about 150 genes homologues to the human chromosome 21.</p>
<p>Loukia is currently investigating why this particular mouse model exhibits a “restless” behavioural phenotype.</p>
</div>
</div>
</div>
</section>
<section id="space-occupancy" class="level2" data-number="5.7">
<h2 data-number="5.7" class="anchored" data-anchor-id="space-occupancy"><span class="header-section-number">5.7</span> Space occupancy</h2>
<p>Apart from quantifying how active the mice were over time, we might also be interested in which parts of the habitat they tend to frequent.</p>
<p><code>movement</code> provides a <a href="https://movement.neuroinformatics.dev/api/movement.plots.plot_occupancy.html"><code>plot_occupancy()</code></a> function to help us visualise the space occupancy.</p>
<div id="fig-occupancy1" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-occupancy1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode cell-code" id="fig-occupancy1"><pre class="sourceCode python cell code-with-copy"><code class="sourceCode python"><span id="fig-occupancy1-1"><a href="#fig-occupancy1-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(</span>
<span id="fig-occupancy1-2"><a href="#fig-occupancy1-2" aria-hidden="true" tabindex="-1"></a>    nrows<span class="op">=</span><span class="dv">1</span>, ncols<span class="op">=</span><span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">4</span>), sharex<span class="op">=</span><span class="va">True</span>, sharey<span class="op">=</span><span class="va">True</span></span>
<span id="fig-occupancy1-3"><a href="#fig-occupancy1-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="fig-occupancy1-4"><a href="#fig-occupancy1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="fig-occupancy1-5"><a href="#fig-occupancy1-5" aria-hidden="true" tabindex="-1"></a>plt.suptitle(<span class="st">"Body centroid occupancy (log scale)"</span>)</span>
<span id="fig-occupancy1-6"><a href="#fig-occupancy1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="fig-occupancy1-7"><a href="#fig-occupancy1-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, kage <span class="kw">in</span> <span class="bu">enumerate</span>([<span class="st">"kage14"</span>, <span class="st">"kage17"</span>]):</span>
<span id="fig-occupancy1-8"><a href="#fig-occupancy1-8" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> images[i]</span>
<span id="fig-occupancy1-9"><a href="#fig-occupancy1-9" aria-hidden="true" tabindex="-1"></a>    height, width <span class="op">=</span> img.shape[:<span class="dv">2</span>]</span>
<span id="fig-occupancy1-10"><a href="#fig-occupancy1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="fig-occupancy1-11"><a href="#fig-occupancy1-11" aria-hidden="true" tabindex="-1"></a>    axes[i].imshow(img)</span>
<span id="fig-occupancy1-12"><a href="#fig-occupancy1-12" aria-hidden="true" tabindex="-1"></a>    plot_occupancy(</span>
<span id="fig-occupancy1-13"><a href="#fig-occupancy1-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Setting the time coordinates to "elapsed time" is necessary</span></span>
<span id="fig-occupancy1-14"><a href="#fig-occupancy1-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># for the log scale to work properly.</span></span>
<span id="fig-occupancy1-15"><a href="#fig-occupancy1-15" aria-hidden="true" tabindex="-1"></a>        ds_kages[kage].body_centroid.set_index(time<span class="op">=</span><span class="st">"seconds_elapsed"</span>),</span>
<span id="fig-occupancy1-16"><a href="#fig-occupancy1-16" aria-hidden="true" tabindex="-1"></a>        ax<span class="op">=</span>axes[i],</span>
<span id="fig-occupancy1-17"><a href="#fig-occupancy1-17" aria-hidden="true" tabindex="-1"></a>        cmap<span class="op">=</span><span class="st">"turbo"</span>,</span>
<span id="fig-occupancy1-18"><a href="#fig-occupancy1-18" aria-hidden="true" tabindex="-1"></a>        norm<span class="op">=</span><span class="st">"log"</span>,  <span class="co"># log scale the colormap</span></span>
<span id="fig-occupancy1-19"><a href="#fig-occupancy1-19" aria-hidden="true" tabindex="-1"></a>        vmax<span class="op">=</span><span class="dv">10</span><span class="op">**</span><span class="dv">6</span>,</span>
<span id="fig-occupancy1-20"><a href="#fig-occupancy1-20" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span><span class="fl">0.6</span>,   <span class="co"># some transparency</span></span>
<span id="fig-occupancy1-21"><a href="#fig-occupancy1-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="fig-occupancy1-22"><a href="#fig-occupancy1-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Make axes match the image dimensions</span></span>
<span id="fig-occupancy1-23"><a href="#fig-occupancy1-23" aria-hidden="true" tabindex="-1"></a>    axes[i].set_ylim([height <span class="op">-</span> <span class="dv">1</span>, <span class="dv">0</span>])</span>
<span id="fig-occupancy1-24"><a href="#fig-occupancy1-24" aria-hidden="true" tabindex="-1"></a>    axes[i].set_xlim([<span class="dv">0</span>, width])</span>
<span id="fig-occupancy1-25"><a href="#fig-occupancy1-25" aria-hidden="true" tabindex="-1"></a>    axes[i].set_title(kage)</span>
<span id="fig-occupancy1-26"><a href="#fig-occupancy1-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="fig-occupancy1-27"><a href="#fig-occupancy1-27" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="fig-occupancy1-28"><a href="#fig-occupancy1-28" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-occupancy1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.6
</figcaption>
</figure>
</div>
<p>We see some clear hotspots, such as the nest and climbing platform. But not all hotspots are created equal. For example, the nest should be occupied when the mouse is stationary but not when it is moving.</p>
<p>To investigate this, let’s choose an arbitrary speed limit of 4 cm/sec, below which we consider the mouse to be stationary.</p>
<div id="fig-speed-histogram" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-speed-histogram-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">4</span>))</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>speed_threshold <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> kage <span class="kw">in</span> [<span class="st">"kage14"</span>, <span class="st">"kage17"</span>]:</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    ds_kages[kage].body_centroid_speed.plot.hist(</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>        ax<span class="op">=</span>ax, bins<span class="op">=</span><span class="dv">50</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, label<span class="op">=</span>kage, histtype<span class="op">=</span><span class="st">"step"</span>,</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>ax.axvline(speed_threshold, linestyle<span class="op">=</span><span class="st">"--"</span>, color<span class="op">=</span><span class="st">"red"</span>, label<span class="op">=</span><span class="st">"Speed threshold"</span>)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Body centroid speed"</span>)</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Speed (cm/sec)"</span>)</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Count"</span>)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>ax.set_yscale(<span class="st">"log"</span>)</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>ax.legend()</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-speed-histogram-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.7
</figcaption>
</figure>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>We use the log scale because speeds tend to be exponentially distributed, i.e.&nbsp;the mouse spends far more time at low speeds than at high speeds. Try commenting out the <code>ax.set_yscale("log")</code> line and see what happens.</p>
</div>
</div>
<p>We will generate separate occupancy heatmaps for when the mouse is stationary vs moving. We can do this by <a href="https://docs.xarray.dev/en/latest/user-guide/indexing.html#masking-with-where">masking with <code>where()</code></a>.</p>
<div id="e99cff33" class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>stationary_mask <span class="op">=</span> ds_kages[<span class="st">"kage14"</span>].body_centroid_speed <span class="op">&lt;</span> <span class="dv">4</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>stationary_mask</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A “mask” is just a boolean array of the same shape as the original data. It’s <code>True</code> where the condition is met, and <code>False</code> otherwise.</p>
<div id="8da41544" class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>stationary_position <span class="op">=</span> ds_kages[<span class="st">"kage14"</span>].body_centroid.where(stationary_mask)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>stationary_position</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We see that the <code>where()</code> method returns a new <code>xarray.DataArray</code> with the same dimensions as the original, but with the data values replaced by <code>NaN</code> where the condition (mask) is <code>False</code>.</p>
<p>Using this approach we can generate separate the body centroid position arrays into states where the mouse is stationary vs moving, and then plot the occupancy heatmaps for each state.</p>
<div id="fig-occupancy2" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-occupancy2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    nrows<span class="op">=</span><span class="dv">2</span>, ncols<span class="op">=</span><span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">8</span>), sharex<span class="op">=</span><span class="va">True</span>, sharey<span class="op">=</span><span class="va">True</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>plt.suptitle(<span class="st">"Body centroid occupancy (log scale)"</span>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, kage <span class="kw">in</span> <span class="bu">enumerate</span>([<span class="st">"kage14"</span>, <span class="st">"kage17"</span>]):</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> images[i]</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    height, width <span class="op">=</span> img.shape[:<span class="dv">2</span>]</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    masks <span class="op">=</span> {</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"stationary"</span>: ds_kages[kage].body_centroid_speed <span class="op">&lt;</span> <span class="dv">4</span>,</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"moving"</span>: ds_kages[kage].body_centroid_speed <span class="op">&gt;=</span> <span class="dv">4</span>,</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j, (mask_name, mask) <span class="kw">in</span> <span class="bu">enumerate</span>(masks.items()):</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>        ax <span class="op">=</span> axes[i, j]</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>        ax.imshow(img)</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>        plot_occupancy(</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>            ds_kages[kage].body_centroid.where(mask).set_index(time<span class="op">=</span><span class="st">"seconds_elapsed"</span>),</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>            ax<span class="op">=</span>ax,</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>            cmap<span class="op">=</span><span class="st">"turbo"</span>,</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>            norm<span class="op">=</span><span class="st">"log"</span>,</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>            vmax<span class="op">=</span><span class="dv">10</span><span class="op">**</span><span class="dv">6</span>,</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>            alpha<span class="op">=</span><span class="fl">0.6</span>,</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>        ax.set_title(<span class="ss">f"</span><span class="sc">{</span>kage<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>mask_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>        ax.set_ylim([height <span class="op">-</span> <span class="dv">1</span>, <span class="dv">0</span>])</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>        ax.set_xlim([<span class="dv">0</span>, width])</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-occupancy2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.8
</figcaption>
</figure>
</div>
<p>We see some expected patterns like the nest being a “hotspot” during stationary periods, and going “dark” during active periods. But we also see some puzzling patterns: for example, the running wheel is occupied during both periods, including when the mouse is “stationary”.</p>
<p>Is that because the mouse appears to be stationary to the camera as it’s running “in-place” on the wheel (like on a treadmill)? Or maybe the mouse spends some of its downtime resting on the wheel?</p>
</section>
<section id="region-of-interest-occupancy" class="level2" data-number="5.8">
<h2 data-number="5.8" class="anchored" data-anchor-id="region-of-interest-occupancy"><span class="header-section-number">5.8</span> Region of interest occupancy</h2>
<p>Let us precisely measure running wheel occupancy, i.e.&nbsp;the proportion of time the mouse spends on the running wheel. Here we’ll use <code>movement</code>’s <a href="https://movement.neuroinformatics.dev/api/movement.roi.html">functionality for defining regions of interest (ROIs)</a>.</p>
<p>Let us create a circular “running wheel” ROI for each of the two kages.</p>
<div id="652058bf" class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>centres <span class="op">=</span> {</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"kage14"</span>: np.array([<span class="dv">145</span>, <span class="dv">260</span>]),  <span class="co"># (x, y)</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"kage17"</span>: np.array([<span class="dv">385</span>, <span class="dv">210</span>]),</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>radius <span class="op">=</span> <span class="dv">70</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a unit circle</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>n_points <span class="op">=</span> <span class="dv">32</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>angles <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">2</span> <span class="op">*</span> np.pi, n_points)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>unit_circle <span class="op">=</span> np.column_stack([np.cos(angles), np.sin(angles)])</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Create ROIs by scaling and shifting the unit circle</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>rois <span class="op">=</span> {}</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> kage <span class="kw">in</span> [<span class="st">"kage14"</span>, <span class="st">"kage17"</span>]:</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    points <span class="op">=</span> centres[kage] <span class="op">+</span> radius <span class="op">*</span> unit_circle</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    roi <span class="op">=</span> PolygonOfInterest(points, name<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>kage<span class="sc">}</span><span class="ss"> running wheel"</span>)</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    rois[kage] <span class="op">=</span> roi</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Admittedly, this is not the most precise or convenient way to define the running wheel ROI. It would be better to directly draw shapes on the video frames.</p>
<p>We are actively working on a widget in <code>napari</code> that will enable this. Stay tuned for updates in <code>movement</code> by joining the <a href="https://neuroinformatics.zulipchat.com/#narrow/stream/406001-Movement">“movement” channel on Zulip</a>.</p>
</div>
</div>
<p>Now that we have the ROIs defined as <code>PolygonOfInterest</code> objects, we can use some of their <a href="https://movement.neuroinformatics.dev/api/movement.roi.PolygonOfInterest.html">built-in methods</a>.</p>
<p>For example, we can use <code>.plot()</code> to visualise the ROIs and verify that they are roughly in the right place.</p>
<div id="fig-rois" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-rois-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(nrows<span class="op">=</span><span class="dv">1</span>, ncols<span class="op">=</span><span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">8</span>))</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, kage <span class="kw">in</span> <span class="bu">enumerate</span>([<span class="st">"kage14"</span>, <span class="st">"kage17"</span>]):</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> images[i]</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    ax[i].imshow(img)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    rois[kage].plot(ax<span class="op">=</span>ax[i], alpha<span class="op">=</span><span class="fl">0.25</span>, facecolor<span class="op">=</span><span class="st">"red"</span>)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    ax[i].legend()</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-rois-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.9
</figcaption>
</figure>
</div>
<p>We can also use <code>.contains_point()</code> to check if a point is inside the ROI. If we pass it a whole <code>xarray.DataArray</code> of points positions, e.g. the positions of the mouse’s body centroid over time, the check is performed for each point in the array.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>The following code cell will take a while to run, probably a few minutes. That’s because we have a large amount of data and the <code>.contains_point()</code> method is not fully optimised yet.</p>
<p>If you are an experienced Python programmer this could be a cool project for the hackday.</p>
</div>
</div>
<div id="440a3b3b" class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>roi_occupancy <span class="op">=</span> {</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    kage: rois[kage].contains_point(ds_kages[kage].body_centroid)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> kage <span class="kw">in</span> [<span class="st">"kage14"</span>, <span class="st">"kage17"</span>]</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>roi_occupancy[<span class="st">"kage14"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The ROI occupancy data is a boolean array which is <code>True</code> when a point (in this case the mouse’s body centroid at each time point) is inside the ROI, and <code>False</code> otherwise.</p>
<div id="fig-roi-occupancy-line" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-roi-occupancy-line-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    nrows<span class="op">=</span><span class="dv">2</span>, ncols<span class="op">=</span><span class="dv">1</span>, figsize<span class="op">=</span>(<span class="fl">7.5</span>, <span class="dv">5</span>), sharex<span class="op">=</span><span class="va">True</span>, sharey<span class="op">=</span><span class="va">True</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, kage <span class="kw">in</span> <span class="bu">enumerate</span>([<span class="st">"kage14"</span>, <span class="st">"kage17"</span>]):</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> axes[i]</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    roi_occupancy[kage].sel(time<span class="op">=</span><span class="bu">slice</span>(<span class="va">None</span>, <span class="st">"2024-04-09 23:59:59"</span>)).plot.line(</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"-"</span>, ax<span class="op">=</span>ax, lw<span class="op">=</span><span class="fl">0.1</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    ax.set_title(kage)</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">"Occupancy"</span>)</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    ax.set_yticks([<span class="dv">0</span>, <span class="dv">1</span>])</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    ax.set_yticklabels([<span class="st">"False"</span>, <span class="st">"True"</span>])</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-roi-occupancy-line-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.10
</figcaption>
</figure>
</div>
<p>We can also compute the % of time the mouse spends on the running wheel.</p>
<div id="5269a4f7" class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> kage <span class="kw">in</span> [<span class="st">"kage14"</span>, <span class="st">"kage17"</span>]:</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Count the ratio of True values in the array</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    on_wheel_ratio <span class="op">=</span> roi_occupancy[kage].mean(dim<span class="op">=</span><span class="st">"time"</span>).values</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert to percentage</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    pct_on_wheel <span class="op">=</span> <span class="bu">float</span>(<span class="dv">100</span> <span class="op">*</span> on_wheel_ratio)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>kage<span class="sc">}</span><span class="ss"> spends </span><span class="sc">{</span>pct_on_wheel<span class="sc">:.1f}</span><span class="ss">% of its time on the running wheel"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>But how does the running wheel occupancy relate to the light cycle? We can segment the ROI occupancy data into dark and light periods for each day and compute the % of time spent on the running wheel during each period.</p>
<div id="0741f122" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>days <span class="op">=</span> <span class="bu">list</span>(</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    roi_occupancy[<span class="st">"kage14"</span>].dropna(dim<span class="op">=</span><span class="st">"time"</span>).groupby(<span class="st">"time.date"</span>).groups.keys()</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>n_days <span class="op">=</span> <span class="bu">len</span>(days)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a new DataArray of NaNs with shape (kage, date, period)</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>daily_occupancy <span class="op">=</span> xr.DataArray(</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    np.full((<span class="dv">2</span>, n_days, <span class="dv">2</span>), np.nan),</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    dims<span class="op">=</span>[<span class="st">"kage"</span>, <span class="st">"date"</span>, <span class="st">"period"</span>],</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    coords<span class="op">=</span>{</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"kage"</span>: [<span class="st">"kage14"</span>, <span class="st">"kage17"</span>],</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"date"</span>: days,</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"period"</span>: [<span class="st">"dark"</span>, <span class="st">"light"</span>]</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> kage <span class="kw">in</span> [<span class="st">"kage14"</span>, <span class="st">"kage17"</span>]:</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> date, day_ds <span class="kw">in</span> roi_occupancy[kage].dropna(dim<span class="op">=</span><span class="st">"time"</span>).groupby(<span class="st">"time.date"</span>):</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>        dark_period <span class="op">=</span> <span class="bu">slice</span>(<span class="ss">f"</span><span class="sc">{</span>date<span class="sc">}</span><span class="ss"> 09:30:00"</span>, <span class="ss">f"</span><span class="sc">{</span>date<span class="sc">}</span><span class="ss"> 21:30:00"</span>)</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>        light_period1 <span class="op">=</span> <span class="bu">slice</span>(<span class="ss">f"</span><span class="sc">{</span>date<span class="sc">}</span><span class="ss"> 00:00:00"</span>, <span class="ss">f"</span><span class="sc">{</span>date<span class="sc">}</span><span class="ss"> 09:30:00"</span>)</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>        light_period2 <span class="op">=</span> <span class="bu">slice</span>(<span class="ss">f"</span><span class="sc">{</span>date<span class="sc">}</span><span class="ss"> 21:30:00"</span>, <span class="ss">f"</span><span class="sc">{</span>date<span class="sc">}</span><span class="ss"> 23:59:59"</span>)</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>        dark_occupancy <span class="op">=</span> <span class="dv">100</span> <span class="op">*</span> day_ds.sel(time<span class="op">=</span>dark_period).mean()</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>        light_occupancy <span class="op">=</span> <span class="dv">100</span> <span class="op">*</span> (</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>            day_ds.sel(time<span class="op">=</span>light_period1).mean() <span class="op">+</span></span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>            day_ds.sel(time<span class="op">=</span>light_period2).mean()</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>        daily_occupancy.loc[<span class="bu">dict</span>(kage<span class="op">=</span>kage, date<span class="op">=</span>date, period<span class="op">=</span><span class="st">"dark"</span>)] <span class="op">=</span> dark_occupancy</span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>        daily_occupancy.loc[<span class="bu">dict</span>(kage<span class="op">=</span>kage, date<span class="op">=</span>date, period<span class="op">=</span><span class="st">"light"</span>)] <span class="op">=</span> light_occupancy</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="2e264f19" class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>daily_occupancy</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s visualise the % of time spent on the running wheel during the light and dark periods of each day.</p>
<div id="fig-roi-occupancy" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-roi-occupancy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(nrows<span class="op">=</span><span class="dv">1</span>, ncols<span class="op">=</span><span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">4</span>), sharex<span class="op">=</span><span class="va">True</span>, sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>max_occupancy <span class="op">=</span> daily_occupancy.<span class="bu">max</span>()</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, kage <span class="kw">in</span> <span class="bu">enumerate</span>([<span class="st">"kage14"</span>, <span class="st">"kage17"</span>]):</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    daily_occupancy.sel(kage<span class="op">=</span>kage).plot(</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>        ax<span class="op">=</span>axes[i], lw<span class="op">=</span><span class="dv">3</span>, vmax<span class="op">=</span>daily_occupancy.<span class="bu">max</span>(), yincrease<span class="op">=</span><span class="va">False</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    axes[i].set_title(<span class="ss">f"</span><span class="sc">{</span>kage<span class="sc">}</span><span class="ss"> running wheel occupancy"</span>)</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    axes[i].set_xticks([<span class="fl">0.25</span>, <span class="fl">0.75</span>])</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>    axes[i].set_ylabel(<span class="st">"Occupancy (%)"</span>)</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>    axes[i].set_xlabel(<span class="st">"Period"</span>)</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-roi-occupancy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.11
</figcaption>
</figure>
</div>
<p>As we would expect, both mice tend to spend more time on the running wheel during the dark (active) periods.</p>
<p>Even though the mouse in <code>kage17</code> is more active overall, as we saw in <a href="#sec-actograms" class="quarto-xref"><span>Section 5.6</span></a>, it spends less time on the running wheel compared to the mouse in <code>kage14</code>.</p>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-dunn_geometric_2021" class="csl-entry" role="listitem">
Dunn, Timothy W., Jesse D. Marshall, Kyle S. Severson, Diego E. Aldarondo, David G. C. Hildebrand, Selmaan N. Chettih, William L. Wang, et al. 2021. <span>“Geometric Deep Learning Enables <span>3D</span> Kinematic Profiling Across Species and Environments.”</span> <em>Nature Methods</em> 18 (5): 564–73. <a href="https://doi.org/10.1038/s41592-021-01106-6">https://doi.org/10.1038/s41592-021-01106-6</a>.
</div>
<div id="ref-ho_fully_2023" class="csl-entry" role="listitem">
Ho, Hinze, Nejc Kejzar, Hiroki Sasaguri, Takashi Saito, Takaomi C. Saido, Bart De Strooper, Marius Bauza, and Julija Krupic. 2023. <span>“A Fully Automated Home Cage for Long-Term Continuous Phenotyping of Mouse Cognition and Behavior.”</span> <em>Cell Reports Methods</em> 3 (7): 100532. <a href="https://doi.org/10.1016/j.crmeth.2023.100532">https://doi.org/10.1016/j.crmeth.2023.100532</a>.
</div>
<div id="ref-karashchuk_anipose_2021" class="csl-entry" role="listitem">
Karashchuk, Pierre, Katie L. Rupp, Evyn S. Dickinson, Sarah Walling-Bell, Elischa Sanders, Eiman Azim, Bingni W. Brunton, and John C. Tuthill. 2021. <span>“Anipose: <span>A</span> Toolkit for Robust Markerless <span>3D</span> Pose Estimation.”</span> <em>Cell Reports</em> 36 (13): 109730. <a href="https://doi.org/10.1016/j.celrep.2021.109730">https://doi.org/10.1016/j.celrep.2021.109730</a>.
</div>
<div id="ref-pereira_quantifying_2020" class="csl-entry" role="listitem">
Pereira, Talmo D., Joshua W. Shaevitz, and Mala Murthy. 2020. <span>“Quantifying Behavior to Understand the Brain.”</span> <em>Nature Neuroscience</em> 23 (12): 1537–49. <a href="https://doi.org/10.1038/s41593-020-00734-z">https://doi.org/10.1038/s41593-020-00734-z</a>.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./04-movement-intro.html" class="pagination-link" aria-label="Analysing tracks with movement">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Analysing tracks with movement</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./06-movement-zebras.html" class="pagination-link" aria-label="Zebra escape trajectories">
        <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Zebra escape trajectories</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>This website is made with <a href="https://quarto.org/docs/books">Quarto Book</a>, see <a href="contributing.html" class="quarto-xref"><span>Appendix B</span></a>.</p>
<div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/neuroinformatics-unit/animals-in-motion/edit/main/book/05-movement-mouse.qmd" target="_blank" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/neuroinformatics-unit/animals-in-motion/blob/main/book/05-movement-mouse.qmd" target="_blank" class="toc-action"><i class="bi empty"></i>View source</a></li><li><a href="https://github.com/neuroinformatics-unit/animals-in-motion/issues/new" target="_blank" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>